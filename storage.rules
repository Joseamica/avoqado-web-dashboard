rules_version = '2';

// Firebase Storage Security Rules para Avoqado
// Estructura:
//   - venues/{venueSlug}/... (legacy, direct paths)
//   - {env}/venues/{venueSlug}/... (new, environment-prefixed paths: dev/, prod/)

service firebase.storage {
  match /b/{bucket}/o {

    // ========== ENVIRONMENT-PREFIXED PATHS (NEW) ==========
    // Covers: dev/venues/... and prod/venues/...
    // Used by: avoqado-tpv Android app for clock-in/out photos, verifications
    match /{environment}/venues/{venueSlug}/{allPaths=**} {
      // Public read for dashboard viewing and email attachments
      allow read: if true;

      // TEMPORAL: Allow all writes for testing
      // TODO: Change to request.auth != null after implementing Firebase Auth in TPV
      allow write: if true;
    }

    // ========== LEGACY PATHS (without environment prefix) ==========
    // Estructura principal por venue (usando slug en lugar de ID)
    // Cubre: productos, logo, staff, verifications (TPV photos)
    match /venues/{venueSlug}/{allPaths=**} {
      // Lectura p√∫blica para mostrar im√°genes en web/apps
      allow read: if true;

      // TEMPORAL: Escritura abierta para debugging (TODO: cambiar a request.auth != null)
      allow write: if true;
    }

    // Reglas espec√≠ficas por tipo de contenido (opcional - m√°s granular)

    // Productos del venue
    match /venues/{venueSlug}/productos/{fileName} {
      allow read: if true;
      allow write: if true; // TEMPORAL
    }

    // Logo del venue
    match /venues/{venueSlug}/logo/{fileName} {
      allow read: if true;
      allow write: if true; // TEMPORAL
    }

    // Avatares de staff
    match /venues/{venueSlug}/staff/{fileName} {
      allow read: if true;
      allow write: if true; // TEMPORAL
    }

    // üì∏ PRE-PAYMENT VERIFICATION PHOTOS (TPV Android App)
    // Path: venues/{venueSlug}/verifications/{date}/{orderRef}_{index}.jpg
    // Example: venues/avoqado-full/verifications/2025-12-12/ORDER-12345_1.jpg
    // Uploaded from: VerificationUploadManager.kt (avoqado-tpv)
    // Purpose: Capture evidence photos before payment processing (retail/telecomunicaciones)
    match /venues/{venueSlug}/verifications/{date}/{fileName} {
      // Public read for dashboard viewing and email attachments
      allow read: if true;

      // TEMPORAL: Allow all writes for testing
      // TODO: Change to request.auth != null after implementing Firebase Auth in TPV
      allow write: if true;
    }
  }
}
