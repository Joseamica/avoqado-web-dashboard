name: ğŸŒ Frontend Monitoring & Performance (Optimized)

on:
  schedule:
    # âœ… OPTIMIZATION: Changed from every hour to every 6 hours (saves ~4,300 min/month!)
    - cron: '0 */6 * * *'  # Runs at 00:00, 06:00, 12:00, 18:00 UTC
  workflow_dispatch:
    inputs:
      check_type:
        description: 'Type of check to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - production
          - staging
          - lighthouse

permissions:
  contents: read
  issues: write

env:
  PRODUCTION_URL: https://dashboardv2.avoqado.io
  STAGING_URL: https://staging.dashboard.avoqado.io

jobs:
  # ğŸŒ Frontend Health Check Production
  frontend-health-production:
    name: ğŸŒ Production Frontend Health
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'production'))

    steps:
      - name: ğŸ” Production Frontend Health Check
        id: prod-frontend-health
        run: |
          echo "ğŸ” Checking production frontend..."

          # âœ… OPTIMIZATION: Single curl with all checks
          RESPONSE=$(curl -s -w "\nHTTP_CODE:%{http_code}\nTIME:%{time_total}\nSIZE:%{size_download}" \
            -H "User-Agent: Mozilla/5.0 (compatible; AvoqadoHealthCheck/1.0)" \
            -L -I \
            $PRODUCTION_URL 2>&1)

          HTTP_CODE=$(echo "$RESPONSE" | grep "HTTP_CODE:" | cut -d: -f2)
          LOAD_TIME=$(echo "$RESPONSE" | grep "TIME:" | cut -d: -f2)

          if [[ "$HTTP_CODE" =~ ^(200|301|302)$ ]]; then
            echo "âœ… Production frontend healthy (HTTP $HTTP_CODE)"
            echo "â±ï¸ Load time: ${LOAD_TIME}s"
            echo "status=healthy" >> $GITHUB_OUTPUT

            # Quick security header check
            if echo "$RESPONSE" | grep -qi "strict-transport-security"; then
              echo "ğŸ”’ Security headers: âœ…"
            fi
          else
            echo "âŒ Production frontend unhealthy (HTTP $HTTP_CODE)"
            echo "status=unhealthy" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸš¨ Production Alert
        if: failure()
        run: |
          echo "ğŸš¨ PRODUCTION FRONTEND DOWN!"
          echo "Time: $(date -u)"
          echo "Site: $PRODUCTION_URL"
          # In production, you'd send this to Slack/PagerDuty/etc.

  # ğŸ§ª Frontend Health Check Staging
  frontend-health-staging:
    name: ğŸ§ª Staging Frontend Health
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'staging'))

    steps:
      - name: ğŸ” Staging Frontend Health Check
        run: |
          echo "ğŸ” Checking staging frontend..."

          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" $STAGING_URL)

          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "âœ… Staging frontend healthy"
          else
            echo "âš ï¸ Staging frontend has issues (HTTP $HTTP_CODE) - non-critical"
          fi

  # ğŸš€ Lighthouse Performance Audit
  lighthouse-audit:
    name: ğŸš€ Lighthouse Performance Audit
    runs-on: ubuntu-latest
    if: |
      (github.event_name == 'workflow_dispatch' &&
       (github.event.inputs.check_type == 'all' || github.event.inputs.check_type == 'lighthouse'))

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v6

      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'

      # âœ… OPTIMIZATION: Cache Lighthouse CLI globally
      - name: ğŸ“¦ Cache Lighthouse CLI
        uses: actions/cache@v5
        with:
          path: ~/.npm
          key: lighthouse-cli-${{ runner.os }}

      - name: ğŸ“¦ Install Lighthouse CI
        run: npm install -g @lhci/cli

      # âœ… OPTIMIZATION: Reduced from 3 runs to 1 (saves ~40 min/month)
      - name: ğŸš€ Run Lighthouse audit
        run: |
          echo "ğŸš€ Running Lighthouse audit on production..."

          lhci autorun \
            --upload.target=temporary-public-storage \
            --collect.url=$PRODUCTION_URL \
            --collect.numberOfRuns=1 \
            --assert.assertions.categories:performance=0.7 \
            --assert.assertions.categories:accessibility=0.8 \
            --assert.assertions.categories:best-practices=0.8 \
            --assert.assertions.categories:seo=0.8 || echo "âš ï¸ Some Lighthouse checks failed"

      - name: ğŸ“Š Performance Summary
        run: |
          echo "ğŸ“Š Lighthouse Performance Targets:"
          echo "  - Performance: â‰¥70"
          echo "  - Accessibility: â‰¥80"
          echo "  - Best Practices: â‰¥80"
          echo "  - SEO: â‰¥80"

  # ğŸ”— API Connectivity Check
  api-connectivity:
    name: ğŸ”— API Connectivity Check
    runs-on: ubuntu-latest
    if: |
      github.event_name == 'schedule' ||
      (github.event_name == 'workflow_dispatch' &&
       github.event.inputs.check_type == 'all')

    steps:
      - name: ğŸ”— Test frontend-to-backend connectivity
        run: |
          echo "ğŸ”— Testing API connectivity..."

          API_URL="https://avoqado-server.onrender.com"

          # Quick API health check
          HTTP_CODE=$(curl -s -o /dev/null -w "%{http_code}" \
            -H "Origin: https://dashboardv2.avoqado.io" \
            $API_URL/health)

          if [[ "$HTTP_CODE" == "200" ]]; then
            echo "âœ… Frontend can reach backend API"
          else
            echo "âš ï¸ API connectivity issue (HTTP $HTTP_CODE)"
          fi

  # ğŸ“Š Generate Health Report
  health-report:
    name: ğŸ“Š Health Report
    runs-on: ubuntu-latest
    needs: [frontend-health-production, frontend-health-staging, api-connectivity]
    if: always() && github.event_name == 'workflow_dispatch'

    steps:
      - name: ğŸ“Š Generate health report
        run: |
          echo "# ğŸŒ Avoqado Frontend Health Report"
          echo "Generated at: $(date -u)"
          echo ""

          echo "## Status Summary"
          echo "- Production: ${{ needs.frontend-health-production.result }}"
          echo "- Staging: ${{ needs.frontend-health-staging.result }}"
          echo "- API: ${{ needs.api-connectivity.result }}"
          echo ""

          echo "## Monitored URLs"
          echo "- Production: https://dashboardv2.avoqado.io"
          echo "- Staging: https://staging.dashboard.avoqado.io"
          echo "- API: https://avoqado-server.onrender.com"
