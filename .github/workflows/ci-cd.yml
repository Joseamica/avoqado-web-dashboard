name: ğŸŒ Avoqado Dashboard CI/CD Pipeline

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to'
        required: true
        default: 'staging'
        type: choice
        options:
          - staging
          - production

permissions:
  contents: read
  actions: read
  pull-requests: write
  issues: write

env:
  NODE_VERSION: '18'

jobs:
  # ğŸ§ª Quality Gate: Test, lint and build
  test-and-build:
    name: ğŸ§ª Test, Lint & Build
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.package-version.outputs.version }}
      build-time: ${{ steps.build-info.outputs.build-time }}
      build-size: ${{ steps.build-size.outputs.size }}
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ“ Run ESLint
        run: npm run lint
        
      - name: ğŸŒ Run i18n validation
        run: npm run lint:i18n
        
      - name: ğŸ” TypeScript compilation check
        run: npx tsc --noEmit
        
      - name: ğŸ—ï¸ Build application for testing
        run: npm run build
        env:
          # Use test environment variables
          VITE_API_URL: 'https://api-test.avoqado.io'
          
      - name: ğŸ“Š Get package version
        id: package-version
        run: echo "version=$(node -p 'require("./package.json").version')" >> $GITHUB_OUTPUT
        
      - name: â° Build info
        id: build-info
        run: echo "build-time=$(date -u +'%Y-%m-%dT%H:%M:%SZ')" >> $GITHUB_OUTPUT
        
      - name: ğŸ“ Calculate build size
        id: build-size
        run: |
          SIZE=$(du -sh dist/ | cut -f1)
          echo "size=$SIZE" >> $GITHUB_OUTPUT
          echo "ğŸ“ Build size: $SIZE"
          
      - name: ğŸ“¤ Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: dashboard-build-${{ github.sha }}
          path: dist/
          retention-days: 7

  # ğŸš€ Deploy to Staging Environment
  deploy-staging:
    name: ğŸš€ Deploy to Staging
    needs: test-and-build
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/develop' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'staging')
    environment: 
      name: staging
      url: https://staging.dashboard.avoqado.io
    
    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build for staging
        run: npm run build
        env:
          # Staging environment variables
          VITE_API_URL: ${{ secrets.VITE_STAGING_API_URL }}
          VITE_FRONTEND_URL: ${{ secrets.VITE_STAGING_FRONTEND_URL }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_STAGING_GOOGLE_CLIENT_ID }}
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_STAGING_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_STAGING_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_RECAPTCHA_SITE_KEY: ${{ secrets.VITE_STAGING_FIREBASE_RECAPTCHA_SITE_KEY }}
          
      - name: ğŸš€ Deploy to Cloudflare Pages (Staging)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name avoqado-web-dashboard --branch develop
          
      - name: â³ Wait for deployment to propagate
        run: |
          echo "â³ Waiting for staging deployment to propagate..."
          sleep 45
          
      - name: ğŸ¥ Staging health check
        run: |
          echo "ğŸ¥ Performing staging health checks..."
          
          # Check if staging is accessible
          for i in {1..10}; do
            if curl -f -s -I https://staging.dashboard.avoqado.io; then
              echo "âœ… Staging deployment accessible!"
              
              # Check if assets are loading
              echo "ğŸ” Verifying static assets..."
              if curl -f -s -I https://staging.dashboard.avoqado.io/assets/ > /dev/null 2>&1; then
                echo "âœ… Static assets loading correctly!"
              fi
              
              break
            fi
            echo "â³ Staging health check attempt $i failed, retrying in 10 seconds..."
            sleep 10
          done
          
          echo "ğŸ‰ Staging deployment successful!"
          
      - name: ğŸ“¢ Notify staging deployment
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "ğŸ‰ âœ… Staging deployment completed successfully!"
            echo "ğŸŒ Environment: https://staging.dashboard.avoqado.io"
            echo "ğŸ“¦ Version: ${{ needs.test-and-build.outputs.version }}"
            echo "ğŸ“ Build size: ${{ needs.test-and-build.outputs.build-size }}"
            echo "ğŸ•’ Build time: ${{ needs.test-and-build.outputs.build-time }}"
          else
            echo "âŒ ğŸš¨ Staging deployment failed!"
            exit 1
          fi

  # ğŸ­ Deploy to Production Environment
  deploy-production:
    name: ğŸ­ Deploy to Production
    needs: test-and-build
    runs-on: ubuntu-latest
    if: |
      (github.ref == 'refs/heads/main' && github.event_name == 'push') ||
      (github.event_name == 'workflow_dispatch' && github.event.inputs.environment == 'production')
    environment: 
      name: production
      url: https://dashboardv2.avoqado.io

    steps:
      - name: ğŸ“¥ Checkout code
        uses: actions/checkout@v4
        
      - name: ğŸŸ¢ Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          
      - name: ğŸ“¦ Install dependencies
        run: npm ci
        
      - name: ğŸ—ï¸ Build for production
        run: npm run build
        env:
          # Production environment variables
          VITE_API_URL: ${{ secrets.VITE_PRODUCTION_API_URL }}
          VITE_FRONTEND_URL: ${{ secrets.VITE_PRODUCTION_FRONTEND_URL }}
          VITE_GOOGLE_CLIENT_ID: ${{ secrets.VITE_PRODUCTION_GOOGLE_CLIENT_ID }}
          VITE_FIREBASE_API_KEY: ${{ secrets.VITE_PRODUCTION_FIREBASE_API_KEY }}
          VITE_FIREBASE_AUTH_DOMAIN: ${{ secrets.VITE_PRODUCTION_FIREBASE_AUTH_DOMAIN }}
          VITE_FIREBASE_RECAPTCHA_SITE_KEY: ${{ secrets.VITE_PRODUCTION_FIREBASE_RECAPTCHA_SITE_KEY }}

      - name: ğŸ­ Deploy to Cloudflare Pages (Production)
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy dist --project-name avoqado-web-dashboard
          
      - name: â³ Wait for production deployment to propagate
        run: |
          echo "â³ Waiting for production deployment to propagate..."
          sleep 60
          
      - name: ğŸ¥ Production health verification
        run: |
          echo "ğŸ¥ Performing comprehensive production health checks..."
          
          # Extended health checks for production
          for i in {1..15}; do
            if curl -f -s -I https://dashboardv2.avoqado.io; then
              echo "âœ… Production health check $i passed!"
              
              # Additional production-specific checks
              echo "ğŸ” Verifying production assets and security headers..."
              
              # Check security headers
              HEADERS=$(curl -s -I https://dashboardv2.avoqado.io)
              if echo "$HEADERS" | grep -i "strict-transport-security" > /dev/null; then
                echo "ğŸ”’ HSTS header present"
              fi
              
              if echo "$HEADERS" | grep -i "x-frame-options" > /dev/null; then
                echo "ğŸ›¡ï¸ X-Frame-Options header present"
              fi
              
              # Check if assets are properly cached
              if curl -f -s -I https://dashboardv2.avoqado.io/assets/ > /dev/null 2>&1; then
                echo "ğŸ“¦ Static assets loading correctly!"
              fi
              
              echo "âœ… All production health checks passed!"
              break
            fi
            echo "â³ Production health check attempt $i failed, retrying in 15 seconds..."
            sleep 15
          done
          
          echo "ğŸ‰ Production deployment successful!"
          
      - name: ğŸ“¢ Notify production deployment
        if: always()
        run: |
          STATUS="${{ job.status }}"
          if [ "$STATUS" = "success" ]; then
            echo "ğŸ‰ âœ… ğŸ­ PRODUCTION DEPLOYMENT SUCCESSFUL! ğŸ­ âœ… ğŸ‰"
            echo "ğŸŒ Environment: https://dashboardv2.avoqado.io"
            echo "ğŸ“¦ Version: ${{ needs.test-and-build.outputs.version }}"
            echo "ğŸ“ Build size: ${{ needs.test-and-build.outputs.build-size }}"
            echo "ğŸ•’ Build time: ${{ needs.test-and-build.outputs.build-time }}"
            echo "ğŸš€ Commit: ${{ github.sha }}"
          else
            echo "âŒ ğŸš¨ PRODUCTION DEPLOYMENT FAILED! ğŸš¨ âŒ"
            exit 1
          fi

  # ğŸ‘€ PR Preview and Quality Report
  deploy-preview:
    name: ğŸ‘€ PR Preview & Quality Report
    runs-on: ubuntu-latest
    if: github.event_name == 'pull_request'
    needs: test-and-build
    
    steps:
      - name: ğŸ’¬ Enhanced PR Comment
        uses: actions/github-script@v8
        with:
          script: |
            const { data: pr } = await github.rest.pulls.get({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: context.issue.number
            });
            
            const buildTime = '${{ needs.test-and-build.outputs.build-time }}';
            const version = '${{ needs.test-and-build.outputs.version }}';
            const buildSize = '${{ needs.test-and-build.outputs.build-size }}';
            
            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: `## ğŸŒ Frontend Build Successful! Ready for Review

            ### ğŸ“Š Build Summary
            - **Branch**: \`${pr.head.ref}\`
            - **Commit**: \`${context.sha.substring(0, 7)}\`
            - **Version**: \`${version}\`
            - **Build size**: \`${buildSize}\`
            - **Built at**: \`${buildTime}\`
            
            ### ğŸ” Quality Checks
            - âœ… **ESLint**: No issues found
            - âœ… **i18n**: All translations valid
            - âœ… **TypeScript**: Compilation successful
            - âœ… **Build**: Successful
            
            ### ğŸŒ Frontend Features
            - **Framework**: Vite + React + TypeScript
            - **Styling**: Tailwind CSS + shadcn/ui
            - **State Management**: Modern React patterns
            - **Internationalization**: Multi-language support
            
            ### ğŸ“¦ Artifacts
            - **Build files**: Available for 7 days
            - **Size optimization**: Enabled for production
            
            ---
            
            ğŸ¯ **Ready for code review!** All automated frontend checks have passed.`
            });
            
      - name: ğŸ“Š Build metrics
        run: |
          echo "ğŸ“Š Frontend Build Metrics Summary:"
          echo "ğŸ•’ Build completed at: ${{ needs.test-and-build.outputs.build-time }}"
          echo "ğŸ“¦ Version: ${{ needs.test-and-build.outputs.version }}"
          echo "ğŸ“ Build size: ${{ needs.test-and-build.outputs.build-size }}"
          echo "ğŸ”„ Workflow run: ${{ github.run_number }}"
          echo "ğŸ“ Commit: ${{ github.sha }}"